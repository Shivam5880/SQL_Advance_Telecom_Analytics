-- 99 RC
-- D-3 & D+3
--UE -- 99RC Base RCHG from 4 Aug
--VLR - Y
--DND - N
--MODE - O/E
********************************************** UE ************************************************************


SELECT SUBS_MSISDN, SUBS_CIRCLE_ID , CURRENT_CV_MRP, REVENUE_END_DT, DEVICE_TYPE , VLR_TAG , MODE FROM 
( SELECT A.SUBS_MSISDN, A.SUBS_CIRCLE_ID , A.RCHG_MRP_AMT AS CURRENT_CV_MRP, A.REVENUE_END_DT ,A.MODE,
CASE WHEN HS.DEVICE_TYPE1 = '4G' THEN '4G' ELSE 'NON4G' END AS DEVICE_TYPE ,
CASE WHEN VLR.SUBS_MSISDN IS NOT NULL THEN 'Y' ELSE 'N' END AS VLR_TAG ,
CASE WHEN DND.SUBS_MSISDN IS NOT NULL THEN 'Y' ELSE 'N' END AS DND_TAG FROM 
(SELECT SUBS_MSISDN, SUBS_CIRCLE_ID, RCHG_CATEGORY, REPORTED_DATE, REVENUE_END_DT, RCHG_MRP_AMT, MODE FROM(
SELECT SUBS_MSISDN,SUBS_CIRCLE_ID,RCHG_CATEGORY,REPORTED_DATE,REVENUE_END_DT,
cast(RCHG_MRP_AMT AS int) AS RCHG_MRP_AMT,RCHG_VALIDITY_IN_DAYS,RCHG_SRC_IDENTIFIER,
CASE WHEN LEFT(RCHG_SRC_IDENTIFIER,1) IN ('6','7','8','9') THEN 'E' ELSE 'O' END MODE,ROW_NUMBER() OVER (PARTITION BY SUBS_MSISDN ORDER BY SUBS_MSISDN,REVENUE_END_DT desc)RN 
FROM DIM_DATALAKE.DIM_SUBS_RCHG_DFRMNT_BASE
WHERE SUBS_CIRCLE_ID IN (21,22) AND RCHG_CATEGORY IN (11) AND RCHG_MRP_AMT = 99)
WHERE RN = 1  ) A        ------------------MRP , revenue_end_date and MODE
LEFT JOIN 
( SELECT DISTINCT SUBS_MSISDN FROM fact_DATALAKE.FCT_SUBS_VLR_HISTORY 
WHERE SUBS_CIRCLE_ID IN (21,22) AND VLR_START_DATE <= CURRENT DATE - 2 DAYS AND VLR_END_DATE >CURRENT DATE - 2 DAYS) VLR ---VLr tag
ON A.SUBS_MSISDN = VLR.SUBS_MSISDN
LEFT JOIN 
( SELECT SUBS_MSISDN , DEVICE_TYPE1 FROM DB2PROJ.HANDSET_MTD_TUP ) HS  -----4G and Non 4G
ON A.SUBS_MSISDN = HS.SUBS_MSISDN
LEFT JOIN 
(  Select subs_msisdn from fact_datalake.FCT_SUBS_DLT_PREF_HISTORY WHERE dnd_prf_end_dt='9999-12-31' GROUP BY subs_msisdn) DND---dnd tag
ON A.SUBS_MSISDN = DND.SUBS_MSISDN
WHERE A.SUBS_CIRCLE_ID IN (21) -----------------CIRCLE
AND A.REVENUE_END_DT BETWEEN CURRENT DATE -2 AND CURRENT DATE +4 )  ---- D-3 & D+3 (EXPIRY CRITERIA)
WHERE   VLR_TAG = 'Y' AND DND_TAG = 'N'
GROUP BY SUBS_MSISDN, SUBS_CIRCLE_ID , CURRENT_CV_MRP, REVENUE_END_DT, DEVICE_TYPE , VLR_TAG, MODE ;


************************************************************ UW ****************************************************************


SELECT SUBS_MSISDN, SUBS_CIRCLE_ID , CURRENT_CV_MRP, REVENUE_END_DT, DEVICE_TYPE , VLR_TAG , MODE FROM 
( SELECT A.SUBS_MSISDN, A.SUBS_CIRCLE_ID , A.RCHG_MRP_AMT AS CURRENT_CV_MRP, A.REVENUE_END_DT ,A.MODE,
CASE WHEN HS.DEVICE_TYPE1 = '4G' THEN '4G' ELSE 'NON4G' END AS DEVICE_TYPE ,
CASE WHEN VLR.SUBS_MSISDN IS NOT NULL THEN 'Y' ELSE 'N' END AS VLR_TAG ,
CASE WHEN DND.SUBS_MSISDN IS NOT NULL THEN 'Y' ELSE 'N' END AS DND_TAG FROM 
(SELECT SUBS_MSISDN, SUBS_CIRCLE_ID, RCHG_CATEGORY, REPORTED_DATE, REVENUE_END_DT, RCHG_MRP_AMT, MODE FROM(
SELECT SUBS_MSISDN,SUBS_CIRCLE_ID,RCHG_CATEGORY,REPORTED_DATE,REVENUE_END_DT,
cast(RCHG_MRP_AMT AS int) AS RCHG_MRP_AMT,RCHG_VALIDITY_IN_DAYS,RCHG_SRC_IDENTIFIER,
CASE WHEN LEFT(RCHG_SRC_IDENTIFIER,1) IN ('6','7','8','9') THEN 'E' ELSE 'O' END MODE,ROW_NUMBER() OVER (PARTITION BY SUBS_MSISDN ORDER BY SUBS_MSISDN,REVENUE_END_DT desc)RN 
FROM DIM_DATALAKE.DIM_SUBS_RCHG_DFRMNT_BASE
WHERE SUBS_CIRCLE_ID IN (21,22) AND RCHG_CATEGORY IN (11) AND RCHG_MRP_AMT = 99)
WHERE RN = 1  ) A        ------------------MRP , revenue_end_date and MODE
LEFT JOIN 
( SELECT DISTINCT SUBS_MSISDN FROM fact_DATALAKE.FCT_SUBS_VLR_HISTORY 
WHERE SUBS_CIRCLE_ID IN (21,22) AND VLR_START_DATE <= CURRENT DATE - 2 DAYS AND VLR_END_DATE >CURRENT DATE - 2 DAYS) VLR ---VLr tag
ON A.SUBS_MSISDN = VLR.SUBS_MSISDN
LEFT JOIN 
( SELECT SUBS_MSISDN , DEVICE_TYPE1 FROM DB2PROJ.HANDSET_MTD_TUP ) HS  -----4G and Non 4G
ON A.SUBS_MSISDN = HS.SUBS_MSISDN
LEFT JOIN 
(  Select subs_msisdn from fact_datalake.FCT_SUBS_DLT_PREF_HISTORY WHERE dnd_prf_end_dt='9999-12-31' GROUP BY subs_msisdn) DND---dnd tag
ON A.SUBS_MSISDN = DND.SUBS_MSISDN
WHERE A.SUBS_CIRCLE_ID IN (22) -----------------CIRCLE
AND A.REVENUE_END_DT BETWEEN CURRENT DATE -2 AND CURRENT DATE +4 )  ---- D-3 & D+3 (EXPIRY CRITERIA)
WHERE   VLR_TAG = 'Y' AND DND_TAG = 'N'
GROUP BY SUBS_MSISDN, SUBS_CIRCLE_ID , CURRENT_CV_MRP, REVENUE_END_DT, DEVICE_TYPE , VLR_TAG, MODE ;
















***************************OLD_QUERY***********************

--UE --old base
--
--
--SELECT A.SUBS_MSISDN,A.SUBS_CIRCLE_ID,A.RCHG_MRP_AMT AS CURRENT_CV_MRP,A.REVENUE_END_DT,A.DEVICE_TYPE,D.RCHG_MRP_AMT AS LAST_120D_RCHG_MRP_AMT,
--E.DATA_MRP AS LAST_30D_DATA_MRP,A.VLR_TAG,
--G.OG_MOU,H.DATA_USAGE_MB,I.ARPU , 'P3' P_TAG
--FROM (SELECT SUBS_MSISDN,SUBS_CIRCLE_ID,REVENUE_END_DT,DEVICE_TYPE,VLR_TAG,MAX(RCHG_MRP_AMT)RCHG_MRP_AMT FROM DB2PROJ.HS_UL_EXPIRY_TEMP
--WHERE REVENUE_END_DT BETWEEN (CURRENT DATE +1) AND (CURRENT DATE +3) AND RCHG_MRP_AMT IN (79,99) AND RECH_TAG IS NULL AND INBASE_TAG = 'Y' AND VLR_TAG = 'Y' AND DND_TAG = 'N'
--GROUP BY SUBS_MSISDN,SUBS_CIRCLE_ID,REVENUE_END_DT,DEVICE_TYPE,VLR_TAG)A
--LEFT JOIN (SELECT SUBS_MSISDN,MAX(RCHG_MRP_AMT)RCHG_MRP_AMT FROM DB2PROJ.HS_FCT_SUBS_RCHG_HISTORY WHERE RCHG_CATEGORY_ID IN (16) AND RCHG_MRP_AMT IN (479,719,199,239,249,269,299,179) AND REPORTED_DATE>=(CURRENT DATE - 120 DAYS) GROUP BY SUBS_MSISDN) D ON A.SUBS_MSISDN=D.SUBS_MSISDN
--LEFT JOIN (SELECT SUBS_MSISDN,MAX(RCHG_MRP_AMT)DATA_MRP FROM DB2PROJ.HS_FCT_SUBS_RCHG_HISTORY WHERE RCHG_MRP_AMT IN (19,25,29,39,51,55,58,75,82,98,108,118,151,298,418,698,999) AND REPORTED_DATE>=(CURRENT DATE - 30) GROUP BY SUBS_MSISDN) E ON A.SUBS_MSISDN=E.SUBS_MSISDN
--LEFT JOIN (SELECT SUBS_MSISDN,OG_MOU FROM DB2PROJ.HS_TEMP_MOU GROUP BY SUBS_MSISDN,OG_MOU) G ON A.SUBS_MSISDN=G.SUBS_MSISDN
--LEFT JOIN (SELECT SUBS_MSISDN,DATA_USAGE_MB FROM  DB2PROJ.HS_TEMP_USAGE GROUP BY SUBS_MSISDN,DATA_USAGE_MB) H ON A.SUBS_MSISDN=H.SUBS_MSISDN
--LEFT JOIN DB2PROJ.ARPU_Jul23_TUP I ON A.SUBS_MSISDN=I.SUBS_MSISDN   
--LEFT JOIN (SELECT SUBS_MSISDN FROM DB2PROJ.UCG_BASE) UCG ON a.SUBS_MSISDN = UCG.SUBS_MSISDN
--WHERE D.SUBS_MSISDN IS NOT NULL	AND UCG.SUBS_MSISDN IS NULL  
--AND A.SUBS_CIRCLE_ID = 21  ;


--UW --old base
--
--SELECT A.SUBS_MSISDN,A.SUBS_CIRCLE_ID,A.RCHG_MRP_AMT AS CURRENT_CV_MRP,A.REVENUE_END_DT,A.DEVICE_TYPE,D.RCHG_MRP_AMT AS LAST_120D_RCHG_MRP_AMT,
--E.DATA_MRP AS LAST_30D_DATA_MRP,A.VLR_TAG,
--G.OG_MOU,H.DATA_USAGE_MB,I.ARPU , 'P3' P_TAG
--FROM (SELECT SUBS_MSISDN,SUBS_CIRCLE_ID,REVENUE_END_DT,DEVICE_TYPE,VLR_TAG,MAX(RCHG_MRP_AMT)RCHG_MRP_AMT FROM DB2PROJ.HS_UL_EXPIRY_TEMP
--WHERE REVENUE_END_DT BETWEEN (CURRENT DATE +1) AND (CURRENT DATE +3) AND RCHG_MRP_AMT IN (79,99) AND RECH_TAG IS NULL AND INBASE_TAG = 'Y' AND VLR_TAG = 'Y' AND DND_TAG = 'N'
--GROUP BY SUBS_MSISDN,SUBS_CIRCLE_ID,REVENUE_END_DT,DEVICE_TYPE,VLR_TAG)A
--LEFT JOIN (SELECT SUBS_MSISDN,MAX(RCHG_MRP_AMT)RCHG_MRP_AMT FROM DB2PROJ.HS_FCT_SUBS_RCHG_HISTORY WHERE RCHG_CATEGORY_ID IN (16) AND RCHG_MRP_AMT IN (479,719,199,239,249,269,299,179) AND REPORTED_DATE>=(CURRENT DATE - 120 DAYS) GROUP BY SUBS_MSISDN) D ON A.SUBS_MSISDN=D.SUBS_MSISDN
--LEFT JOIN (SELECT SUBS_MSISDN,MAX(RCHG_MRP_AMT)DATA_MRP FROM DB2PROJ.HS_FCT_SUBS_RCHG_HISTORY WHERE RCHG_MRP_AMT IN (19,25,29,39,51,55,58,75,82,98,108,118,151,298,418,698,999) AND REPORTED_DATE>=(CURRENT DATE - 30) GROUP BY SUBS_MSISDN) E ON A.SUBS_MSISDN=E.SUBS_MSISDN
--LEFT JOIN (SELECT SUBS_MSISDN,OG_MOU FROM DB2PROJ.HS_TEMP_MOU GROUP BY SUBS_MSISDN,OG_MOU) G ON A.SUBS_MSISDN=G.SUBS_MSISDN
--LEFT JOIN (SELECT SUBS_MSISDN,DATA_USAGE_MB FROM  DB2PROJ.HS_TEMP_USAGE GROUP BY SUBS_MSISDN,DATA_USAGE_MB) H ON A.SUBS_MSISDN=H.SUBS_MSISDN
--LEFT JOIN DB2PROJ.ARPU_Jul23_TUP I ON A.SUBS_MSISDN=I.SUBS_MSISDN   
--LEFT JOIN (SELECT SUBS_MSISDN FROM DB2PROJ.UCG_BASE) UCG ON a.SUBS_MSISDN = UCG.SUBS_MSISDN
--WHERE D.SUBS_MSISDN IS NOT NULL	AND UCG.SUBS_MSISDN IS NULL 
--AND A.SUBS_CIRCLE_ID = 22   ;






--------------END----------------------------------